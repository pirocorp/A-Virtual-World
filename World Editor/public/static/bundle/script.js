(()=>{"use strict";var t,e;!function(t){t.Aqua="Aqua",t.Black="Black",t.Blue="Blue",t.Fuchsia="Fuchsia",t.Gray="Gray",t.Green="Green",t.Lime="Lime",t.Maroon="Maroon",t.Navy="Navy",t.Olive="Olive",t.Purple="Purple",t.Random="Random",t.Red="Red",t.Silver="Silver",t.Teal="Teal",t.White="White",t.Yellow="Yellow"}(t||(t={}));class s{constructor(t,e){this._x=t,this._y=e}get x(){return this._x}get y(){return this._y}equals(t){return this._x===t.x&&this._y===t.y}add(t){return new s(this._x+t.x,this._y+t.y)}subtract(t){return new s(this._x-t.x,this._y-t.y)}distance(t){return Math.hypot(this._x-t.x,this._y-t.y)}scale(t){return new s(this._x*t,this._y*t)}mutate(t){this._x=t.x,this._y=t.y}draw(e,s={size:18,color:t.Black,outline:!1,fill:!1}){const n=s.size/2;e.beginPath(),e.fillStyle=s.color,e.arc(this._x,this._y,n,0,2*Math.PI),e.fill(),s.outline&&(e.beginPath(),e.lineWidth=2,e.strokeStyle=t.Yellow,e.arc(this._x,this._y,.6*n,0,2*Math.PI),e.stroke()),s.fill&&(e.beginPath(),e.fillStyle=t.Yellow,e.arc(this._x,this._y,.4*n,0,2*Math.PI),e.fill())}static getNearestPoint(t,e,s=Number.MAX_SAFE_INTEGER){let n=Number.MAX_SAFE_INTEGER,i=null;for(const o of e){const e=t.distance(o);e<n&&e<s&&(i=o,n=e)}return i}static parse(t){return new s(t._x,t._y)}}!function(t){t[t.LeftButton=0]="LeftButton",t[t.MiddleButton=1]="MiddleButton",t[t.RigthButton=2]="RigthButton"}(e||(e={}));class n{constructor(t){this._zoomStep=.1,this._minZoom=1,this._maxZoom=5,this._canvas=t,this._context=this._canvas.getContext("2d"),this._zoom=1,this._center=new s(this._canvas.width/2,this._canvas.height/2),this._offset=this._center.scale(-1),this._drag={start:new s(0,0),end:new s(0,0),offset:new s(0,0),active:!1},this.onMoueseWheelEventHandler=this.onMoueseWheelEventHandler.bind(this),this.onMoueseDownEventHandler=this.onMoueseDownEventHandler.bind(this),this.onMoueseMoveEventHandler=this.onMoueseMoveEventHandler.bind(this),this.onMoueseUpEventHandler=this.onMoueseUpEventHandler.bind(this),this.getMouse=this.getMouse.bind(this),this.addEventListeners()}get zoom(){return this._zoom}get context(){return this._context}getMouse(t,e=!1){const n=new s((t.offsetX-this._center.x)*this._zoom-this._offset.x,(t.offsetY-this._center.y)*this._zoom-this._offset.y);return e?n.subtract(this._drag.offset):n}reset(){this._context.restore(),this.clearCanvas(),this._context.save(),this.centerAndZoomTheCanvas()}getOffset(){return this._offset.add(this._drag.offset)}addEventListeners(){this._canvas.addEventListener("mousewheel",(t=>this.onMoueseWheelEventHandler(t))),this._canvas.addEventListener("mousedown",this.onMoueseDownEventHandler),this._canvas.addEventListener("mousemove",this.onMoueseMoveEventHandler),this._canvas.addEventListener("mouseup",this.onMoueseUpEventHandler)}onMoueseWheelEventHandler(t){const e=Math.sign(t.deltaY);this._zoom+=e*this._zoomStep,this._zoom=Math.max(this._minZoom,Math.min(this._maxZoom,this._zoom))}onMoueseDownEventHandler(t){t.button==e.MiddleButton&&(this._drag.start=this.getMouse(t),this._drag.active=!0)}onMoueseMoveEventHandler(t){this._drag.active&&(this._drag.end=this.getMouse(t),this._drag.offset=this._drag.end.subtract(this._drag.start))}onMoueseUpEventHandler(t){this._drag.active&&(this._offset=this._offset.add(this._drag.offset),this._drag={start:new s(0,0),end:new s(0,0),offset:new s(0,0),active:!1})}clearCanvas(){this._context.clearRect(0,0,this._canvas.width,this._canvas.height)}centerAndZoomTheCanvas(){this._context.translate(this._center.x,this._center.y),this._context.scale(1/this._zoom,1/this._zoom);const t=this.getOffset();this._context.translate(t.x,t.y)}}class i{constructor(t,e){this._a=t,this._b=e}get pointA(){return this._a}get pointB(){return this._b}equals(t){return this.includes(t.pointA)&&this.includes(t.pointB)}includes(t){return this.pointA.equals(t)||this.pointB.equals(t)}draw(e,s={width:2,color:t.Black,dash:[]}){e.beginPath(),e.lineWidth=s.width,e.strokeStyle=s.color,e.setLineDash(s.dash),e.moveTo(this._a.x,this._a.y),e.lineTo(this._b.x,this._b.y),e.stroke(),e.setLineDash([])}}class o{constructor(t=[],e=[]){this._points=t,this._segments=e}get points(){return this._points}get segments(){return this._segments}tryAddPoint(t){return!this.containsPoint(t)&&(this._points.push(t),!0)}tryAddSegment(t){return!this.containsSegment(t)&&!t.pointA.equals(t.pointB)&&(this._segments.push(t),!0)}tryRemovePoint(t){if(0==this._points.length)return!1;const e=this._points.indexOf(t);if(e<0)return!1;const s=this.getSegmentsContainingPoint(t);for(const t of s)this.tryRemoveSegment(t);return this._points.splice(e,1),!0}tryRemoveSegment(t){if(0==this._segments.length)return!1;const e=this._segments.indexOf(t);return!(e<0||(this._segments.splice(e,1),0))}dispose(){this._points.length=0,this._segments.length=0}containsPoint(t){return this._points.some((e=>e.equals(t)))}containsSegment(t){return this._segments.some((e=>e.equals(t)))}getSegmentsContainingPoint(t){let e=[];for(const s of this._segments)s.includes(t)&&e.push(s);return e}}const h=document.getElementById("canvas"),a=document.getElementById("controls"),r=new class{constructor(e,s,i=[],h=[]){this._localStorageKey="graph",this._pointTresholdDistance=10,this._pointOptions={size:18,color:t.Black,outline:!1,fill:!1},this._segmentOptions={width:2,color:t.Black,dash:[]},this._selected=null,this._hovered=null,this._dragging=!1,this._mouse=null,this._canvasContainer=e,this._controlsContainer=s,this._graph=new o(i,h),this._canvas=this.initializeCanvas(),this._viewport=new n(this._canvas),this.onMouseDownEventHandler=this.onMouseDownEventHandler.bind(this),this.onMouseMoveEventHandler=this.onMouseMoveEventHandler.bind(this),this.onContextMenuEventHandler=this.onContextMenuEventHandler.bind(this),this.onMouseUpEventHandler=this.onMouseUpEventHandler.bind(this),this.onSaveButtonClickHandler=this.onSaveButtonClickHandler.bind(this),this.onDeleteButtonClickHandler=this.onDeleteButtonClickHandler.bind(this),this.draw=this.draw.bind(this),this.addEventListeners(),this.loadControls(),this.loadSavedGraph()}display(){this._viewport.reset(),this.draw(this._viewport.context)}draw(t){var e;for(const e of this._graph.segments)e.draw(t);for(const e of this._graph.points)e.draw(t,this._pointOptions);if(this._selected){this._selected.draw(t,Object.assign(Object.assign({},this._pointOptions),{outline:!0}));const s=null!==(e=this._hovered)&&void 0!==e?e:this._mouse;new i(this._selected,s).draw(t,Object.assign(Object.assign({},this._segmentOptions),{dash:[3,3]}))}this._hovered&&this._hovered.draw(t,Object.assign(Object.assign({},this._pointOptions),{fill:!0}))}initializeCanvas(){const t=document.createElement("canvas");return t.id="main-canvas",t.width=1600,t.height=700,t.style.border="1px solid",this._canvasContainer.appendChild(t),t}addEventListeners(){this._canvas.addEventListener("mousedown",this.onMouseDownEventHandler),this._canvas.addEventListener("mousemove",this.onMouseMoveEventHandler),this._canvas.addEventListener("contextmenu",this.onContextMenuEventHandler),this._canvas.addEventListener("mouseup",this.onMouseUpEventHandler)}onMouseDownEventHandler(t){t.button==e.RigthButton&&this.handleRightClick(),t.button==e.LeftButton&&this.handleLeftClick()}onMouseMoveEventHandler(t){var e;this._mouse=this._viewport.getMouse(t,!0);const n=this._pointTresholdDistance*this._viewport.zoom;this._hovered=s.getNearestPoint(this._mouse,this._graph.points,n),1==this._dragging&&(null===(e=this._selected)||void 0===e||e.mutate(this._mouse))}onMouseUpEventHandler(t){this._dragging=!1}onContextMenuEventHandler(t){t.preventDefault()}onSaveButtonClickHandler(t){localStorage.setItem(this._localStorageKey,JSON.stringify(this._graph))}onDeleteButtonClickHandler(t){this.dispose()}handleLeftClick(){if(this._hovered)return this.selectPoint(this._hovered),void(this._dragging=!0);this._graph.tryAddPoint(this._mouse)&&(this.selectPoint(this._mouse),this._hovered=this._mouse)}handleRightClick(){this._selected?this._selected=null:this._hovered&&this.removePoint(this._hovered)}selectPoint(t){if(this._selected){const e=new i(this._selected,t);this._graph.tryAddSegment(e)}this._selected=t}removePoint(t){this._graph.tryRemovePoint(t),this._hovered=null,this._selected==t&&(this._selected=null)}dispose(){this._graph.dispose(),this._hovered=null,this._selected=null}loadControls(){const t=document.createElement("button");t.textContent="💾",t.addEventListener("click",this.onSaveButtonClickHandler);const e=document.createElement("button");e.textContent="🗑️",e.addEventListener("click",this.onDeleteButtonClickHandler),this._controlsContainer.appendChild(t),this._controlsContainer.appendChild(e)}loadSavedGraph(){const t=localStorage.getItem("graph"),e=t?JSON.parse(t):null;if(e){this._graph.dispose(),e._points.map(s.parse).forEach((t=>this._graph.tryAddPoint(t)));for(const t of e._segments){const e=this.findPointInGraph(t._a),s=this.findPointInGraph(t._b),n=new i(e,s);this._graph.tryAddSegment(n)}}}findPointInGraph(t){return this._graph.points.find((e=>e.x===t._x&&e.y===t._y))}}(h,a);!function t(){r.display(),requestAnimationFrame(t)}()})();