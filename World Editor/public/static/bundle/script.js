(()=>{"use strict";var t,e;!function(t){t.Aqua="Aqua",t.Black="Black",t.Blue="Blue",t.Fuchsia="Fuchsia",t.Gray="Gray",t.Green="Green",t.Lime="Lime",t.Maroon="Maroon",t.Navy="Navy",t.Olive="Olive",t.Purple="Purple",t.Random="Random",t.Red="Red",t.Silver="Silver",t.Teal="Teal",t.White="White",t.Yellow="Yellow"}(t||(t={}));class s{constructor(e,s){this._defaultOptions={size:18,color:t.Black,outline:!1,fill:!1},this._x=e,this._y=s}get x(){return this._x}get y(){return this._y}equals(t){return this._x===t.x&&this._y===t.y}distance(t){return Math.hypot(this._x-t.x,this._y-t.y)}angle(){return Math.atan2(this._y,this._x)}add(t){return new s(this._x+t.x,this._y+t.y)}subtract(t){return new s(this._x-t.x,this._y-t.y)}scale(t){return new s(this._x*t,this._y*t)}translate(t,e){return new s(this._x+Math.cos(t)*e,this._y+Math.sin(t)*e)}mutate(t){this._x=t.x,this._y=t.y}draw(e,s){const n=(s=Object.assign(Object.assign({},this._defaultOptions),s)).size/2;e.beginPath(),e.fillStyle=s.color,e.arc(this._x,this._y,n,0,2*Math.PI),e.fill(),s.outline&&(e.beginPath(),e.lineWidth=2,e.strokeStyle=t.Yellow,e.arc(this._x,this._y,.6*n,0,2*Math.PI),e.stroke()),s.fill&&(e.beginPath(),e.fillStyle=t.Yellow,e.arc(this._x,this._y,.4*n,0,2*Math.PI),e.fill())}static getNearestPoint(t,e,s=Number.MAX_SAFE_INTEGER){let n=Number.MAX_SAFE_INTEGER,i=null;for(const o of e){const e=t.distance(o);e<n&&e<s&&(i=o,n=e)}return i}static parse(t){return new s(t._x,t._y)}static angle(t){return Math.atan2(t.y,t.x)}}function n(t,e,s){return t+(e-t)*s}class i{constructor(e,s){this._defaultOptions={width:2,color:t.Black,dash:[]},this.pointA=e,this.pointB=s}equals(t){return this.includes(t.pointA)&&this.includes(t.pointB)}includes(t){return this.pointA.equals(t)||this.pointB.equals(t)}draw(t,e){e=Object.assign(Object.assign({},this._defaultOptions),e),t.beginPath(),t.lineWidth=e.width,t.strokeStyle=e.color,t.setLineDash(e.dash),t.moveTo(this.pointA.x,this.pointA.y),t.lineTo(this.pointB.x,this.pointB.y),t.stroke(),t.setLineDash([])}static getIntersection(t,e){let s=null;const i=t.pointA,o=t.pointB,h=e.pointA,a=e.pointB,r=(a.x-h.x)*(i.y-h.y)-(a.y-h.y)*(i.x-h.x),l=(h.y-i.y)*(i.x-o.x)-(h.x-i.x)*(i.y-o.y),d=(a.y-h.y)*(o.x-i.x)-(a.x-h.x)*(o.y-i.y);if(0!=d){const t=r/d,e=l/d;t>=0&&t<=1&&e>=0&&e<=1&&(s={x:n(i.x,o.x,t),y:n(i.y,o.y,t),offset:t})}return s}}class o{constructor(t=[],e=[]){this._points=t,this._segments=e}get points(){return this._points}get segments(){return this._segments}tryAddPoint(t){return!this.containsPoint(t)&&(this._points.push(t),!0)}tryAddSegment(t){return!this.containsSegment(t)&&!t.pointA.equals(t.pointB)&&(this._segments.push(t),!0)}tryRemovePoint(t){if(0==this._points.length)return!1;const e=this._points.indexOf(t);if(e<0)return!1;const s=this.getSegmentsContainingPoint(t);for(const t of s)this.tryRemoveSegment(t);return this._points.splice(e,1),!0}tryRemoveSegment(t){if(0==this._segments.length)return!1;const e=this._segments.indexOf(t);return!(e<0||(this._segments.splice(e,1),0))}dispose(){this._points.length=0,this._segments.length=0}containsPoint(t){return this._points.some((e=>e.equals(t)))}containsSegment(t){return this._segments.some((e=>e.equals(t)))}getSegmentsContainingPoint(t){let e=[];for(const s of this._segments)s.includes(t)&&e.push(s);return e}}!function(t){t[t.LeftButton=0]="LeftButton",t[t.MiddleButton=1]="MiddleButton",t[t.RigthButton=2]="RigthButton"}(e||(e={}));class h{constructor(t){this._zoomStep=.1,this._minZoom=1,this._maxZoom=5,this._canvas=t,this._context=this._canvas.getContext("2d"),this._zoom=1,this._center=new s(this._canvas.width/2,this._canvas.height/2),this._offset=this._center.scale(-1),this._drag={start:new s(0,0),end:new s(0,0),offset:new s(0,0),active:!1},this.onMoueseWheelEventHandler=this.onMoueseWheelEventHandler.bind(this),this.onMoueseDownEventHandler=this.onMoueseDownEventHandler.bind(this),this.onMoueseMoveEventHandler=this.onMoueseMoveEventHandler.bind(this),this.onMoueseUpEventHandler=this.onMoueseUpEventHandler.bind(this),this.getMouse=this.getMouse.bind(this),this.addEventListeners()}get zoom(){return this._zoom}get context(){return this._context}getMouse(t,e=!1){const n=new s((t.offsetX-this._center.x)*this._zoom-this._offset.x,(t.offsetY-this._center.y)*this._zoom-this._offset.y);return e?n.subtract(this._drag.offset):n}reset(){this._context.restore(),this.clearCanvas(),this._context.save(),this.centerAndZoomTheCanvas()}getOffset(){return this._offset.add(this._drag.offset)}addEventListeners(){this._canvas.addEventListener("mousewheel",(t=>this.onMoueseWheelEventHandler(t))),this._canvas.addEventListener("mousedown",this.onMoueseDownEventHandler),this._canvas.addEventListener("mousemove",this.onMoueseMoveEventHandler),this._canvas.addEventListener("mouseup",this.onMoueseUpEventHandler)}onMoueseWheelEventHandler(t){const e=Math.sign(t.deltaY);this._zoom+=e*this._zoomStep,this._zoom=Math.max(this._minZoom,Math.min(this._maxZoom,this._zoom))}onMoueseDownEventHandler(t){t.button==e.MiddleButton&&(this._drag.start=this.getMouse(t),this._drag.active=!0)}onMoueseMoveEventHandler(t){this._drag.active&&(this._drag.end=this.getMouse(t),this._drag.offset=this._drag.end.subtract(this._drag.start))}onMoueseUpEventHandler(t){this._drag.active&&(this._offset=this._offset.add(this._drag.offset),this._drag={start:new s(0,0),end:new s(0,0),offset:new s(0,0),active:!1})}clearCanvas(){this._context.clearRect(0,0,this._canvas.width,this._canvas.height)}centerAndZoomTheCanvas(){this._context.translate(this._center.x,this._center.y),this._context.scale(1/this._zoom,1/this._zoom);const t=this.getOffset();this._context.translate(t.x,t.y)}}class a{constructor(e){this._defaultOptions={stroke:t.Blue,lineWidth:2,fill:"rgba(0, 0, 255, 0.3)"},this._points=e,this._segments=[],this.initializeSegments()}draw(t,e){e=Object.assign(Object.assign({},this._defaultOptions),e),t.beginPath(),t.fillStyle=e.fill,t.strokeStyle=e.stroke,t.lineWidth=e.lineWidth,t.moveTo(this._points[0].x,this._points[0].y);for(let e=1;e<this._points.length;e++){const s=this._points[e];t.lineTo(s.x,s.y)}t.closePath(),t.fill(),t.stroke()}drawSegments(t){for(let e=0;e<this._segments.length;e++)this._segments[e].draw(t,{color:`hsl(${290+260*Math.random()}, 100%, 60%)`,width:5})}initializeSegments(){if(!(this._points.length<2))for(let t=1;t<=this._points.length;t++){const e=this._points[t-1],s=this._points[t%this._points.length],n=new i(e,s);this._segments.push(n)}}static break(t,e){const n=t._segments,o=e._segments;for(let t=0;t<n.length;t++){const e=n[t];for(let h=0;h<o.length;h++){const a=o[h],r=i.getIntersection(e,a);if(r&&1!=r.offset&&0!=r.offset){const l=new s(r.x,r.y);let d=e.pointB;e.pointB=l,n.splice(t+1,0,new i(l,d)),d=a.pointB,a.pointB=l,o.splice(h+1,0,new i(l,d))}}}}static multiBreak(t){for(let e=0;e<t.length-1;e++){const s=t[e];for(let n=e+1;n<t.length;n++){const e=t[n];a.break(s,e)}}}}class r{constructor(t,e,s=0){this._skeleton=t,this._polygon=this.generatePolygon(e,s)}get polygon(){return this._polygon}draw(t){this._polygon.draw(t),this._polygon.drawSegments(t)}generatePolygon(t,e){const{pointA:n,pointB:i}=this._skeleton,o=t/2,h=s.angle(n.subtract(i)),r=h+Math.PI/2,l=h-Math.PI/2,d=[],_=Math.PI/Math.max(1,e),c=_/2;for(let t=l;t<=r+c;t+=_)d.push(n.translate(t,o));for(let t=l;t<=r+c;t+=_)d.push(i.translate(Math.PI+t,o));return new a(d)}}const l=document.getElementById("canvas"),d=document.getElementById("controls"),_=new class{constructor(t,e,s=[],n=[]){this._localStorageKey="graph",this._pointTresholdDistance=10,this._selected=null,this._hovered=null,this._dragging=!1,this._mouse=null,this._canvasContainer=t,this._controlsContainer=e,this._graph=new o(s,n),this._canvas=this.initializeCanvas(),this._viewport=new h(this._canvas),this.onMouseDownEventHandler=this.onMouseDownEventHandler.bind(this),this.onMouseMoveEventHandler=this.onMouseMoveEventHandler.bind(this),this.onContextMenuEventHandler=this.onContextMenuEventHandler.bind(this),this.onMouseUpEventHandler=this.onMouseUpEventHandler.bind(this),this.onSaveButtonClickHandler=this.onSaveButtonClickHandler.bind(this),this.onDeleteButtonClickHandler=this.onDeleteButtonClickHandler.bind(this),this.draw=this.draw.bind(this),this.addEventListeners(),this.loadControls(),this.loadSavedGraph()}get context(){return this._viewport.context}get graph(){return this._graph}display(){this._viewport.reset(),this.draw(this._viewport.context)}draw(t){var e;for(const e of this._graph.segments)e.draw(t);for(const e of this._graph.points)e.draw(t);if(this._selected){this._selected.draw(t,{outline:!0});const s=null!==(e=this._hovered)&&void 0!==e?e:this._mouse;new i(this._selected,s).draw(t,{dash:[3,3]})}this._hovered&&this._hovered.draw(t,{fill:!0})}initializeCanvas(){const t=document.createElement("canvas");return t.id="main-canvas",t.width=1600,t.height=700,t.style.border="1px solid",this._canvasContainer.appendChild(t),t}addEventListeners(){this._canvas.addEventListener("mousedown",this.onMouseDownEventHandler),this._canvas.addEventListener("mousemove",this.onMouseMoveEventHandler),this._canvas.addEventListener("contextmenu",this.onContextMenuEventHandler),this._canvas.addEventListener("mouseup",this.onMouseUpEventHandler)}onMouseDownEventHandler(t){t.button==e.RigthButton&&this.handleRightClick(),t.button==e.LeftButton&&this.handleLeftClick()}onMouseMoveEventHandler(t){var e;this._mouse=this._viewport.getMouse(t,!0);const n=this._pointTresholdDistance*this._viewport.zoom;this._hovered=s.getNearestPoint(this._mouse,this._graph.points,n),1==this._dragging&&(null===(e=this._selected)||void 0===e||e.mutate(this._mouse))}onMouseUpEventHandler(t){this._dragging=!1}onContextMenuEventHandler(t){t.preventDefault()}onSaveButtonClickHandler(t){localStorage.setItem(this._localStorageKey,JSON.stringify(this._graph))}onDeleteButtonClickHandler(t){this.dispose()}handleLeftClick(){if(this._hovered)return this.selectPoint(this._hovered),void(this._dragging=!0);this._graph.tryAddPoint(this._mouse)&&(this.selectPoint(this._mouse),this._hovered=this._mouse)}handleRightClick(){this._selected?this._selected=null:this._hovered&&this.removePoint(this._hovered)}selectPoint(t){if(this._selected){const e=new i(this._selected,t);this._graph.tryAddSegment(e)}this._selected=t}removePoint(t){this._graph.tryRemovePoint(t),this._hovered=null,this._selected==t&&(this._selected=null)}dispose(){this._graph.dispose(),this._hovered=null,this._selected=null}loadControls(){const t=document.createElement("button");t.textContent="ðŸ’¾",t.addEventListener("click",this.onSaveButtonClickHandler);const e=document.createElement("button");e.textContent="ðŸ—‘ï¸",e.addEventListener("click",this.onDeleteButtonClickHandler),this._controlsContainer.appendChild(t),this._controlsContainer.appendChild(e)}loadSavedGraph(){const t=localStorage.getItem("graph"),e=t?JSON.parse(t):null;if(e){this._graph.dispose(),e._points.map(s.parse).forEach((t=>this._graph.tryAddPoint(t)));for(const t of e._segments){const e=this.findPointInGraph(t.pointA),s=this.findPointInGraph(t.pointB),n=new i(e,s);this._graph.tryAddSegment(n)}}}findPointInGraph(t){return this._graph.points.find((e=>e.x===t._x&&e.y===t._y))}}(l,d),c=new class{constructor(t,e=100,s=3){this._graph=t,this._roadWidth=e,this._roadRoundness=s,this._envelopes=[],this.generate()}generate(){this.generateEnvelopes(),a.multiBreak(this._envelopes.map((t=>t.polygon)))}draw(t){this.drawEnvelopes(t)}generateEnvelopes(){this._envelopes.length=0;for(const t of this._graph.segments){const e=new r(t,this._roadWidth,this._roadRoundness);this._envelopes.push(e)}}drawEnvelopes(t){for(const e of this._envelopes)e.draw(t)}}(_.graph);!function t(){_.display(),c.generate(),c.draw(_.context),requestAnimationFrame(t)}()})();